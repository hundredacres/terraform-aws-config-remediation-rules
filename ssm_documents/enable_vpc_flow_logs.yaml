---
schemaVersion: '0.3'
description: 'Enable VPC Flow Logs for a VPC that does not have them enabled'
assumeRole: '{{ AutomationAssumeRole }}'
parameters:
  AutomationAssumeRole:
    type: String
    description: 'The ARN of the role that allows Automation to perform the actions'
    default: ''
  VpcId:
    type: String
    description: 'The VPC ID to enable flow logs for'
mainSteps:
  - name: CheckExistingFlowLogs
    action: 'aws:executeAwsApi'
    description: 'Check if VPC already has flow logs enabled'
    inputs:
      Service: ec2
      Api: DescribeFlowLogs
      Filters:
        - Name: resource-id
          Values:
            - '{{ VpcId }}'
    outputs:
      - Name: FlowLogs
        Selector: $.FlowLogs
        Type: MapList
  - name: CheckIfFlowLogsExist
    action: 'aws:branch'
    description: 'Branch based on whether flow logs already exist'
    inputs:
      Choices:
        - NextStep: SkipCreation
          Variable: '{{ CheckExistingFlowLogs.FlowLogs }}'
          Contains: FlowLogId
      Default: CreateLogGroup
  - name: CreateLogGroup
    action: 'aws:executeAwsApi'
    description: 'Create CloudWatch Log Group for VPC Flow Logs'
    onFailure: Continue
    inputs:
      Service: logs
      Api: CreateLogGroup
      logGroupName: '${LogGroupNamePrefix}{{ VpcId }}'
    outputs:
      - Name: LogGroupName
        Selector: $.logGroupName
        Type: String
  - name: EnableFlowLogs
    action: 'aws:executeAwsApi'
    description: 'Enable VPC Flow Logs'
    inputs:
      Service: ec2
      Api: CreateFlowLogs
      ResourceIds:
        - '{{ VpcId }}'
      ResourceType: VPC
      TrafficType: '${TrafficType}'
      LogDestinationType: cloud-watch-logs
      LogGroupName: '${LogGroupNamePrefix}{{ VpcId }}'
      DeliverLogsPermissionArn: '${FlowLogsRoleArn}'
    outputs:
      - Name: FlowLogIds
        Selector: $.FlowLogIds
        Type: StringList
      - Name: Unsuccessful
        Selector: $.Unsuccessful
        Type: MapList
%{ if SNSTopicArn != "" ~}
  - name: SendNotification
    action: 'aws:executeAwsApi'
    description: 'Send SNS notification about VPC Flow Logs enablement'
    inputs:
      Service: sns
      Api: Publish
      TopicArn: '${SNSTopicArn}'
      Subject: 'VPC Flow Logs Enabled'
      Message: 'VPC Flow Logs have been enabled for VPC {{ VpcId }}. Log Group: ${LogGroupNamePrefix}{{ VpcId }}. Flow Log IDs: {{ EnableFlowLogs.FlowLogIds }}'
    isEnd: true
%{ endif ~}
  - name: SkipCreation
    action: 'aws:sleep'
    description: 'Flow logs already exist, no action needed'
    inputs:
      Duration: PT1S
